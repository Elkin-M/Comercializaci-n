<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Productos - Productos del Caribe</title>
    <link rel="stylesheet" href="../css/registroproducto.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
 <style>
     

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-color: white;
        }

        .container-main {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }
 </style>

<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.php">
                            <i class="fas fa-home"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="registro_productos.html">
                            <i class="fas fa-plus-circle"></i> Registrar Producto
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="lista_productos.php">
                            <i class="fas fa-list"></i> Lista de Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mis_pedidos.php">
                            <i class="fas fa-shopping-cart"></i> Mis Pedidos
                        </a>
                    </li>
                </ul>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> Mi Perfil
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user"></i> Perfil</a></li>
                        <li><a class="dropdown-item" href="../backend/logout.php"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    <br>
    <div class="page-header">
        <h1> Registro de Productos</h1>
    </div>

    <div class="contenedor">
        

        <a href="../views/lista_productos.php">Mis productos</a>

        <div class="input-seccion">
            <input type="file" id="inputImagen" accept="image/*">
            <button type="button" id="botonAnalizar">Analizar Producto</button>
        </div>

        <img id="imagenProducto" src="" alt="Imagen de producto" style="display:none; max-width:100%; height:auto; margin:20px auto;">
        <div id="resultadoAnalisis"></div>

        <form id="formularioProducto" method="POST" action="../backend/guardar_producto.php" enctype="multipart/form-data" style="display:none;">
            <div class="form-group">
                <label for="nombreProducto">Nombre del Producto:</label>
                <input type="text" id="nombreProducto" name="titulo" required>
            </div>
            <div class="form-group">
                <label for="descripcionProducto">Descripción:</label>
                <textarea id="descripcionProducto" name="descripcion" required></textarea>
            </div>
            <div class="form-group">
                <label for="precioProducto">Precio (COP por kg):</label>
                <input type="number" id="precioProducto" name="precio" required>
            </div>
            <div class="form-group">
                <label for="cantidadProducto">Cantidad Disponible (kg):</label>
                <input type="number" id="cantidadProducto" name="cantidad" required>
            </div>
            <div class="form-group">
                <label for="imagenProductoInput">Imagen del Producto:</label>
                <input type="file" id="imagenProductoInput" name="imagen" accept="image/*" required style="display:block;">
            </div>

            <input type="hidden" id="campesinoId" name="campesino_id" value="">

            <button type="submit" id="guardarProducto">Guardar Producto</button>
        </form>
    </div>

    <script type="importmap">
        {
          "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
          }
        }
    </script>
    
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai"
        const clave = "AIzaSyAzSRphbn7QyM-9wIcxLTwHlgjlPaPg5oc"
    
        const genAI = new GoogleGenerativeAI(clave)
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" })

        const inputImagen = document.querySelector("#inputImagen");
        const imagenProducto = document.querySelector("#imagenProducto");
        const botonAnalizar = document.querySelector("#botonAnalizar");
        const resultadoAnalisis = document.querySelector("#resultadoAnalisis");
        const formularioProducto = document.getElementById('formularioProducto');
        const campesinoIdInput = document.querySelector("#campesinoId");

        // Obtener el campesino_id desde el almacenamiento local
        const campesinoId = localStorage.getItem("campesino_id");

        if (!campesinoId) {
            alert('No se encontró el ID del campesino. Por favor, inicie sesión de nuevo.');
            window.location.href = 'login.html';
        } else {
            campesinoIdInput.value = campesinoId;
        }

        inputImagen.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagenProducto.src = e.target.result;
                    imagenProducto.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        botonAnalizar.addEventListener("click", async () => {
            if (!imagenProducto.src || imagenProducto.src === "") {
                resultadoAnalisis.innerHTML = "<p class='loading'>Por favor, selecciona una imagen de producto primero.</p>";
                return;
            }

            desactivarBoton();
            resultadoAnalisis.innerHTML = "<p class='loading'>Analizando la imagen...</p>";

            try {
                const imageData = await getImageData(imagenProducto);
                const prompt = `Eres un experto en identificación y valoración de frutas y verduras de colombia en especial del departamento de bolivar. 
                Analiza la imagen proporcionada y proporciona la siguiente información en formato JSON:
                1. Identifica específicamente qué fruta o verdura es, considerando las variedades típicas del Caribe colombiano
                2. Proporciona una descripción comercial enfocada en sus características de calidad y frescura
                3. Estima un precio realista en pesos colombianos basado en el mercado actual (solo el número, sin símbolos ni puntos)
                4. Sugiere una cantidad típica de inventario en kilogramos (solo el número)

                Responde ÚNICAMENTE con un JSON con esta estructura (sin texto adicional ni markdown):
                {
                    "nombre": "nombre específico de la fruta en español",
                    "descripcion": "descripción comercial breve y específica",
                    "precio": 5000,
                    "cantidad": 100
                }`;

                const result = await model.generateContent([prompt, imageData]);
                const response = await result.response;
                const responseText = await response.text();
                
                // Limpiar y parsear la respuesta
                const cleanedResponse = responseText.replace(/```json|```/g, '').trim();
                console.log("Respuesta limpia:", cleanedResponse); // Para debugging
                const jsonData = JSON.parse(cleanedResponse);

                // Validar los datos antes de mostrarlos
                if (!jsonData.nombre || !jsonData.descripcion || 
                    typeof jsonData.precio === 'undefined' || 
                    typeof jsonData.cantidad === 'undefined') {
                    throw new Error("La respuesta del análisis está incompleta");
                }

                // Asegurarse de que precio y cantidad sean números
                jsonData.precio = Number(jsonData.precio);
                jsonData.cantidad = Number(jsonData.cantidad);

                if (isNaN(jsonData.precio) || isNaN(jsonData.cantidad)) {
                    throw new Error("Los valores de precio o cantidad no son números válidos");
                }

                mostrarTarjetaProducto(jsonData);
            } catch (error) {
                console.error("Error detallado:", error); // Para debugging
                resultadoAnalisis.innerHTML = `<p class="error">Error en el análisis: ${error.message}</p>`;
            } finally {
                activarBoton();
            }
        });

        function mostrarTarjetaProducto(data) {
            const cardHTML = `
                <div class="producto-card">
                    <img src="${imagenProducto.src}" alt="${data.nombre}" class="producto-imagen">
                    <div class="producto-info">
                        <h2 class="producto-titulo">${data.nombre}</h2>
                        <p class="producto-descripcion">${data.descripcion}</p>
                        <p class="producto-precio">Precio: $${data.precio.toLocaleString('es-CO')} COP/kg</p>
                        <p class="producto-cantidad">Disponible: ${data.cantidad} kg</p>
                    </div>
                </div>
            `;
            resultadoAnalisis.innerHTML = cardHTML;

            // Rellenar el formulario
            document.getElementById('nombreProducto').value = data.nombre;
            document.getElementById('descripcionProducto').value = data.descripcion;
            document.getElementById('precioProducto').value = data.precio;
            document.getElementById('cantidadProducto').value = data.cantidad;

            formularioProducto.style.display = 'block';
        }

        async function getImageData(img) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve({
                        inlineData: {
                            data: reader.result.split(',')[1],
                            mimeType: 'image/jpeg'
                        }
                    });
                    reader.readAsDataURL(blob);
                }, 'image/jpeg');
            });
        }

        function desactivarBoton() {
            botonAnalizar.disabled = true;
            botonAnalizar.innerText = "Analizando...";
        }

        function activarBoton() {
            botonAnalizar.disabled = false;
            botonAnalizar.innerText = "Analizar Producto";
        }
    </script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>




